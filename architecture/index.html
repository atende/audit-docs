<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Architecture - Audit</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../extra.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Architecture";
    var mkdocs_page_input_path = "architecture.md";
    var mkdocs_page_url = "/architecture/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Audit</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Architecture</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#architecture">Architecture</a></li>
                
                    <li><a class="toctree-l4" href="#deployment">Deployment</a></li>
                
            
            </ul>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Audit</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Architecture</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="architecture">Architecture</h1>
<p>Each component play a role in the architecture represented by Figure 1:</p>
<p><img alt="components" src="../images/component_diagram.png" /></p>
<p>Let's start by talking about what an application need to do to be audited.</p>
<p>A application need's to do only one thing: <strong>Publish AuditEvents</strong></p>
<p>Suppose you want to audit every login and logout to a system. The login event is the event you need to catch in your application and publish in the message bus</p>
<p>The message you publish is a standard message modeled by the <strong>AuditEvent</strong> class in the <strong>audit-model</strong> component. The audit-model component just
creates a standard data transfer object class to be published, consumed and stored by the system. The message need to be in JSON format, you can serialize the AuditEvent class, but
if you use the audit-appclient-framework, it abstract that for you and try to provide a API for communication that is aware of you framework. Current, only spring
framework is supported.</p>
<p>But you don't need to use <em>audit-model</em> or <em>audit-appclient-whatever</em>, in your application, you just need to publish a standard json object to the bus</p>
<p>How is the AuditEvent object?</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>The id is auto generated by the storage</td>
</tr>
<tr>
<td>applicationName</td>
<td>A identification of the application. You should take care that each application must have a unique applicationName across the others</td>
</tr>
<tr>
<td>userName</td>
<td>Who make the action? Normally the user name of the current login in user</td>
</tr>
<tr>
<td>action</td>
<td>What happen? The action must identify what happen in the event, it should be a verb, it should be standardized, after all someone will search for that</td>
</tr>
<tr>
<td>resource.resouceType</td>
<td>The resource represents, what or who has been affected by the action. Resource type is the class of resources. Example: person</td>
</tr>
<tr>
<td>resource.resourceId</td>
<td>The resource id represents the unity that has been affected by the action. Example: 123 Multiple values uses ; to separate. Example 123;456</td>
</tr>
<tr>
<td>dateTime</td>
<td>When the event was generated.</td>
</tr>
<tr>
<td>ip</td>
<td>The ip address of the client machine for the user that generate the event.</td>
</tr>
<tr>
<td>securityLevel</td>
<td>A way to classify the severity of the event. Only supports 3 values: LOW, NORMAL, HIGHT</td>
</tr>
<tr>
<td>description</td>
<td>A optional description of the event, or could be used for other information</td>
</tr>
</tbody>
</table>
<p>With that object you can interpret a AuditEvent as this (order of the table above)</p>
<pre><code>SGL - fooUser - ldap_enable - person - 123 - Sat May 21 08:14:59 - 10.0.1.1 - NORMAL -
</code></pre>
<p>That line means user fooUser in the application SGL has enable in ldap the person 123 on Sat May 21 08:14:59, the user was in the machine 10.0.1.1 and this is a normal operation</p>
<p>Is crucial that the actions should be standardized and the resources too. Some actions are common across every applications, some makes sense
only for a particular app. </p>
<p>The underline should be used to separate the concerns. In the exemplo above <em>ldap_enable</em> separates the actual action <strong>enable</strong> for a more specific
action <em>ldap</em>. That means the user has enable in some ldap respository, not that the user has enabled in the application itself.</p>
<p>Other examples:</p>
<ul>
<li>database_insert - An insert in the database</li>
<li>database_update - An update in the database</li>
<li>database_delete - A delete in the database</li>
<li>database_select - A select in the database</li>
<li>database_insert_or_update - A insert or update operation in database</li>
<li>user_login - The user has login</li>
<li>user_logout - The user has logout</li>
<li>user_enable - The user has been enabled</li>
<li>ldap_create - The ldap object has been created</li>
<li>ldap_read - The ldap object has been readed</li>
<li>ldap_change_password - The ldap password of the object has been changed</li>
</ul>
<p>If a action is specific for the application, use the name of application as a prefix. Example <strong>sgl_reset_password</strong></p>
<p>The <strong>audit-model</strong> component lib has some common actions.</p>
<p>Enough information in one event, don't you think?
The objective of a audit system, is to identify who does what and when. That event can create a good representation of that. If you don't agree, let me know.
Is entire possible to persist non standardize json objects in the future.</p>
<p>What is the bus? The RabbitMQ component is a robust and easy to use message queue, that is the bus I'm talking about. Current is the only supported message queue, but probally you don't need other.</p>
<p>Ok. Get a standard message in JSON that represents an audit event, and publish on the message queue, easy right? What happens next?</p>
<p>The next component takes the action now. The <strong>audit-mq-collector</strong> is a message queue collector that only knows how to get a message in the queue and store it :-)</p>
<p>That is it, audit-mq-collector takes a message in the queue and store in the database. Current it only talks with a postgresql database, and stores in a single table for good performance</p>
<p>If the system grow's, you could need a cluster of postgresql databases, or you could create a cluster of the nosql of your choise for insane performance
or you could even add a new audit-mq-collector that talks to another database and replicates to a master view. 
In that case, you need to change only this component, and the audit-view</p>
<p>What is the audit-view?</p>
<p>Is just a nice look view of the database, where people can search for events. You can do that with the standard tools of the database. The advantages 
of the audit-view are:</p>
<ol>
<li>Better for non tecnical users</li>
<li>Authenticates with JBoss Keycloak Server</li>
<li>Is a simple web app</li>
</ol>
<p>Now that you know the basics, lets talk about some challends and fun:</p>
<ol>
<li>Do everything async: The queue is not only to publish the events, is to make the system performant and scalable. For that goal every application that publish the events, need to do that 
in a async way.</li>
<li>Use Aspect Oriented Programming: To catch the events, aspect oriented programming is the best way. The audit-appclient-spring component will do that. We have some challends here,
sometimes it will need developer logic or annotations to represent the AuditEvent better. I'm investigating on this, check the audit-appclient-spring for more details</li>
</ol>
<h2 id="deployment">Deployment</h2>
<p>It could be implanted like in the Figure 2:</p>
<p><img alt="deployment" src="../images/deployment_diagram.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>

</body>
</html>
